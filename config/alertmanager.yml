# AlertManageré…ç½® - å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥è®¾ç½®

global:
  # SMTPé…ç½® (é‚®ä»¶é€šçŸ¥)
  smtp_smarthost: 'localhost:587'
  smtp_from: 'alerts@feynman-system.com'
  smtp_auth_username: 'alerts@feynman-system.com'
  smtp_auth_password: 'your-email-password'

# æŠ‘åˆ¶é‡å¤å‘Šè­¦
inhibit_rules:
  # APIæœåŠ¡ä¸‹çº¿æ—¶ï¼ŒæŠ‘åˆ¶APIç›¸å…³çš„å…¶ä»–å‘Šè­¦
  - source_matchers:
      - alertname="APIServiceDown"
    target_matchers:
      - component="api"
    equal: ['instance']

  # ç³»ç»Ÿèµ„æºä¸¥é‡ä¸è¶³æ—¶ï¼ŒæŠ‘åˆ¶æ€§èƒ½ç›¸å…³å‘Šè­¦
  - source_matchers:
      - alertname=~"HighCPUUsage|HighMemoryUsage"
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal: ['instance']

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶å™¨
  receiver: 'default-notifications'
  
  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'component']
  group_wait: 30s        # ç­‰å¾…åŒç»„å…¶ä»–å‘Šè­¦
  group_interval: 5m     # å‘é€æ–°å‘Šè­¦å‰çš„é—´éš”
  repeat_interval: 12h   # é‡å¤å‘é€é—´éš”
  
  # è·¯ç”±è§„åˆ™
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³é€šçŸ¥
    - matchers:
        - severity="critical"
      receiver: 'critical-notifications'
      group_wait: 10s
      repeat_interval: 5m

    # APIç›¸å…³å‘Šè­¦
    - matchers:
        - component="api"
      receiver: 'api-team-notifications'
      group_by: ['alertname', 'endpoint']

    # LLMæˆæœ¬å‘Šè­¦
    - matchers:
        - component="cost"
      receiver: 'cost-notifications'
      group_wait: 0s  # ç«‹å³å‘é€æˆæœ¬å‘Šè­¦

    # ä¸šåŠ¡æŒ‡æ ‡å‘Šè­¦
    - matchers:
        - component="business"
      receiver: 'business-notifications'
      repeat_interval: 24h  # ä¸šåŠ¡å‘Šè­¦æ¯å¤©æœ€å¤šå‘é€ä¸€æ¬¡

    # å¼€å‘ç¯å¢ƒå‘Šè­¦ (é™ä½ä¼˜å…ˆçº§)
    - matchers:
        - environment="development"
      receiver: 'dev-notifications'
      repeat_interval: 1h

# æ¥æ”¶å™¨é…ç½®
receivers:
  # é»˜è®¤é€šçŸ¥
  - name: 'default-notifications'
    webhook_configs:
      - url: 'http://localhost:8005/webhooks/alerts'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'alertmanager'
            password: 'webhook-secret'

  # ä¸¥é‡å‘Šè­¦é€šçŸ¥
  - name: 'critical-notifications'
    # é‚®ä»¶é€šçŸ¥
    email_configs:
      - to: 'admin@feynman-system.com'
        subject: 'ğŸš¨ [CRITICAL] è´¹æ›¼å­¦ä¹ ç³»ç»Ÿä¸¥é‡å‘Šè­¦'
        body: |
          å‘Šè­¦åç§°: {{ .GroupLabels.alertname }}
          ç»„ä»¶: {{ .GroupLabels.component }}
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
          
          æŸ¥çœ‹è¯¦æƒ…: {{ .ExternalURL }}
        html: |
          <h2>ğŸš¨ è´¹æ›¼å­¦ä¹ ç³»ç»Ÿä¸¥é‡å‘Šè­¦</h2>
          <p><strong>å‘Šè­¦åç§°:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>ç»„ä»¶:</strong> {{ .GroupLabels.component }}</p>
          
          {{ range .Alerts }}
          <div style="background: #f8d7da; padding: 10px; margin: 10px 0; border-radius: 5px;">
            <h3>{{ .Annotations.summary }}</h3>
            <p>{{ .Annotations.description }}</p>
            <p><strong>å¼€å§‹æ—¶é—´:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          </div>
          {{ end }}
    
    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥ (å¯é€‰)
    webhook_configs:
      - url: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_WECHAT_WEBHOOK_KEY'
        send_resolved: true
        http_config:
          headers:
            Content-Type: application/json
        title: 'è´¹æ›¼å­¦ä¹ ç³»ç»Ÿä¸¥é‡å‘Šè­¦'
        text: |
          **å‘Šè­¦**: {{ .GroupLabels.alertname }}
          **ç»„ä»¶**: {{ .GroupLabels.component }}
          {{ range .Alerts }}
          **è¯¦æƒ…**: {{ .Annotations.description }}
          {{ end }}

  # APIå›¢é˜Ÿé€šçŸ¥
  - name: 'api-team-notifications'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#api-alerts'
        title: 'APIå‘Šè­¦ - {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          ğŸ“Š **ç«¯ç‚¹**: {{ .Labels.endpoint }}
          âš ï¸ **é—®é¢˜**: {{ .Annotations.summary }}
          ğŸ“ **è¯¦æƒ…**: {{ .Annotations.description }}
          ğŸ• **æ—¶é—´**: {{ .StartsAt.Format "15:04:05" }}
          {{ end }}

  # æˆæœ¬é€šçŸ¥
  - name: 'cost-notifications'
    email_configs:
      - to: 'finance@feynman-system.com,admin@feynman-system.com'
        subject: 'ğŸ’° è´¹æ›¼å­¦ä¹ ç³»ç»Ÿæˆæœ¬å‘Šè­¦'
        body: |
          æ£€æµ‹åˆ°æˆæœ¬å¼‚å¸¸:
          
          {{ range .Alerts }}
          å‘Šè­¦: {{ .Annotations.summary }}
          è¯¦æƒ…: {{ .Annotations.description }}
          å½“å‰æˆæœ¬: {{ .Labels.cost_usd }}
          é¢„ç®—: {{ .Labels.budget_usd }}
          {{ end }}
          
          è¯·ç«‹å³æ£€æŸ¥ç³»ç»Ÿä½¿ç”¨æƒ…å†µå’Œæˆæœ¬æ§åˆ¶è®¾ç½®ã€‚

  # ä¸šåŠ¡é€šçŸ¥
  - name: 'business-notifications'
    webhook_configs:
      - url: 'http://localhost:8005/webhooks/business-alerts'
        send_resolved: true

  # å¼€å‘ç¯å¢ƒé€šçŸ¥
  - name: 'dev-notifications'
    webhook_configs:
      - url: 'http://localhost:8005/webhooks/dev-alerts'
        send_resolved: true

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'


